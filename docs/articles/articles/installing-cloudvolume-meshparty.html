<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Installing cloudvolume and meshparty • fafbseg</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Installing cloudvolume and meshparty">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">fafbseg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/FAFB-FlyWire.html">FAFB-FlyWire</a>
    </li>
    <li>
      <a href="../../articles/articles/accessing-graphene-server.html">Accessing the chunked graph server</a>
    </li>
    <li>
      <a href="../../articles/articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a>
    </li>
    <li>
      <a href="../../articles/articles/installing-cloudvolume-meshparty.html">Installing cloudvolume and meshparty</a>
    </li>
    <li>
      <a href="../../articles/articles/mesh-to-mesh.html">Mesh to mesh distances</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
<li>
  <a href="../../SUPPORT.html">Help</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://natverse.github.io">natverse</a>
</li>
<li>
  <a href="https://github.com/natverse/fafbseg">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Installing cloudvolume and meshparty</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/fafbseg/blob/master/vignettes/articles/installing-cloudvolume-meshparty.Rmd"><code>vignettes/articles/installing-cloudvolume-meshparty.Rmd</code></a></small>
      <div class="hidden name"><code>installing-cloudvolume-meshparty.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>We need cloudvolume and meshparty for python in order to get flywire meshes. This help article is written for those with not experience using python. For more experienced users, see cloud-volume install and basic command info <a href="https://github.com/seung-lab/cloud-volume">here</a>.</p>
<p>If you are new to python, especially to <code>pip</code>, and <code>conda</code>, this <a href="https://jakevdp.github.io/blog/2016/08/25/conda-myths-and-misconceptions/">blogpost</a> can be helpful in understanding what’s what.</p>
<p>Bottomline is that <code>conda</code> can install python and non-python software to a specific environment, trying to keep that environment functional by taking different dependencies of packages into consideration, while <code>pip</code> installs only python packages to wherever you want, whatever you tell it to install. In general there are more packages that you can <code>pip</code> install (from PyPi), but you can also do this in a <code>conda</code> environment without a problem in most cases.</p>
<p>Since there are a bunch of non-python dependencies for <strong>cloud-volume</strong> and <strong>meshparty</strong> , <code>conda</code> looks better for what we want.</p>
</div>
<div id="install-conda" class="section level2">
<h2 class="hasAnchor">
<a href="#install-conda" class="anchor"></a>Install conda</h2>
<p><a href="https://docs.conda.io/en/latest/miniconda.html">Download</a> <strong>miniconda</strong> and install it, this includes only <code>conda</code>, python, and a few very basic packages, including <code>pip</code>:</p>
<p>Make sure you know where you install it (e.g. usually here: <code>/opt/miniconda3</code>), and update it to the most recent version in the Terminal:</p>
<p><code>$ conda update conda</code></p>
<p>Hit ‘y’ to proceed if prompted.</p>
<p>After this the default python is <code>/opt/miniconda3/bin/python</code>, you can check with</p>
<p><code>$ which python</code></p>
</div>
<div id="work-with-a-new-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#work-with-a-new-environment" class="anchor"></a>Work with a new environment</h2>
<p>Use <strong>conda</strong> to create and activate an environment where we can install everything we need:</p>
<pre><code>$ conda create --name flywire_env python=3.7
$ conda activate flywire_env
$ conda install nomkl</code></pre>
<p>(To deactivate an active environment, use <code>$ conda deactivate flywire_env</code>)</p>
<p>At this point we are in our environment and we can use <code>conda install &lt;package_name&gt;</code> simply for anything that’s available <a href="https://anaconda.org/anaconda/repo">here</a>, and <code>pip</code> should also install packages in this environment, unless your PATH variable in your bash.profile file tells it otherwise. Check which <code>pip</code> is default:</p>
<p><code>$ which pip</code></p>
<p>This should give you something under your miniconda folder, like <code>/opt/miniconda3/envs/flywire_env/bin/pip</code>.</p>
<p>However, you might have your system python’s <code>pip</code>. You can comment out the PATH variable for python in your .bash.profile by running:</p>
<p><code>$ touch ~/.bash_profile; open ~/.bash_profile</code></p>
<p>and adding a <code>#</code> before lines <code>PATH="/Library/Frameworks/Python.framework/Versions/3.7/bin:${PATH}"</code> and <code>export PATH</code>. After this <code>which pip</code> will return the right thing, same thing applies to <code>which python</code>.</p>
<p>Alternatively you can always specify in the terminal which <code>pip</code> you want to use, but this is suboptimal (e.g. <code>/opt/miniconda3/envs/flywire_env/bin/pip install cloud-volume</code>).</p>
</div>
<div id="install-cloudvolume" class="section level2">
<h2 class="hasAnchor">
<a href="#install-cloudvolume" class="anchor"></a>Install cloudvolume</h2>
<p>Now we can install <strong>cloud-volume</strong> with</p>
<p><code>$ pip install cloud-volume</code></p>
<p>You will need a compiler (XCode on Mac) to install everything. If you don’t have XCode, you either need to updat your OSX to the most recent version to download it from AppStore, or you can get any version compatible with your current system from here: <a href="https://developer.apple.com/support/xcode/" class="uri">https://developer.apple.com/support/xcode/</a></p>
<p>We have not tried installing on Windows, try to get the right compiler with help from Google. In the thread on <a href="https://flywire-forum.slack.com/archives/CM86C8H7F/p1570470089014000">FlyWire Slack</a> you might find other useful things.</p>
<p>To use <strong>cloud-volume</strong>, you need to get a token for authorisation here: <a href="https://globalv1.flywire-daf.com/auth/api/v1/refresh_token" class="uri">https://globalv1.flywire-daf.com/auth/api/v1/refresh_token</a>, and add this to a <code>.json</code> file that you create in this location: <code>~/.cloudvolume/secrets/chunkedgraph-secret.json</code>, see help for this <a href="http://natverse.org/fafbseg/articles/articles/accessing-graphene-server.html">here</a>.</p>
</div>
<div id="install-meshparty" class="section level2">
<h2 class="hasAnchor">
<a href="#install-meshparty" class="anchor"></a>Install meshparty</h2>
<p>Install <strong>meshparty</strong>:</p>
<p><code>$ pip install meshparty</code></p>
<p>This errored out for me with a failure to install the dependency: <strong>pykdtree</strong> <code>clang: error: unsupported option '-fopenmp'</code>. This is an issue with my gcc compiler version (probably), good thing we’re using <code>conda</code> now so we can do:</p>
<p><code>$ conda install -c conda-forge pykdtree</code></p>
<p>After this <code>pip</code> installing <strong>meshparty</strong> worked fine with the previous command.</p>
<p>Now we have both <strong>meshparty</strong> and <strong>cloud-volume</strong> in this environment, but <strong>meshparty</strong> has a few more optional dependencies for skeletonisation, that we need to install:</p>
<pre><code>$ conda install -c conda-forge pyembree
$ pip install annotationframeworkclient</code></pre>
<p>In order to use <code>meshparty_skeletonisation</code> I also had to install <strong>PyChunkedGraph</strong>, which has a dependency called <strong>igneous</strong>, both are from the Seung lab.</p>
<p>Install <strong>igneous</strong> from GitHub, and then <code>pip</code> install <strong>PyChunkedGraph</strong>:</p>
<pre><code>$ git clone git@github.com:seung-lab/igneous.git
$ cd igneous
$ pip install -r requirements.txt
$ python setup.py develop
$ pip install PyChunkedGraph</code></pre>
</div>
<div id="working-with-r-and-python" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-r-and-python" class="anchor"></a>Working with R and python</h2>
<p>If we want to use these packages in <code>R</code> through reticulate with all the <strong>natverse</strong> and <strong>fafbseg</strong> functions and objects then we need to have the package <strong>reticulate</strong> in <code>R</code> (<code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("reticulate")</a></code>) and tell it to use this python version in our <code>conda</code> environment.</p>
<p>Run in <code>R</code> console:<code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code> and add the line <code>RETICULATE_PYTHON="/opt/miniconda3/envs/flywire_env/bin/python"</code> with your path to the python under the <code>conda</code> environment. Be sure to leave a blank line at the end of the file.</p>
<p>Restart R session, load <strong>reticulate</strong> and <strong>fafbseg</strong> (if necessay install/update with <code><a href="https://remotes.r-lib.org/reference/install_github.html">remotes::install_github("jefferis/fafbseg")</a></code>. Check your python version with <code><a href="https://rdrr.io/pkg/reticulate/man/py_config.html">reticulate::py_config()</a></code>, it should show the same path what you gave to the <code>RETICULATE_PYTHON</code> variable.</p>
<p>It is possible that your RStudio session will crash with <code><a href="https://rdrr.io/pkg/reticulate/man/py_config.html">reticulate::py_config()</a></code>. This may be because multiple copies of the OpenMP runtime have been linked into the program. That is dangerous, since it can degrade performance or cause incorrect results. To fix, try:</p>
<pre><code>conda uninstall numpy
conda install nomkl numpy scipy scikit-learn numexpr
conda remove mkl mkl-service</code></pre>
<div id="the-natverse-and-flywire-meshes" class="section level3">
<h3 class="hasAnchor">
<a href="#the-natverse-and-flywire-meshes" class="anchor"></a>The natverse and flywire meshes</h3>
<p>Let’s set up R to look at the write flywire data. You need to have access to the production node of the flywire environment (i.e. passed the test).</p>
<p>Use <code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_profile</a></code>, and in your R profile add:</p>
<pre><code><a href="https://rdrr.io/r/base/options.html"># Production flywire
options(fafbseg.cloudvolume.url='graphene://https://prodv1.flywire-daf.com/segmentation/1.0/fly_v31')</a></code></pre>
<p>After this you should be able to read meshes, skeletonise them, and plot both with FAFB:</p>
<pre><code><a href="https://rdrr.io/r/base/library.html"># Load packages
library(natverse)
library(fafbseg)
choose_segmentation("flywire")
dir.create("flywire_skeletons")

# Get mesh
id = flywire_xyz2id(matrix(c(160464, 71968, 2292),ncol=3), rawcoords = TRUE)
neuron_mesh = read_cloudvolume_meshes(id)

# Skeletonise mesh
meshparty_skeletonize("720575940627832275", savedir = "flywire_skeletons")
neuron_skel &lt;- read.neuron.swc(sprintf("flywire_skeletons/%s.swc",id))

nopen3d()
plot3d(FAFB, alpha = 0.1)
plot3d(neuron_skel, WithNodes = F, col = "red", lwd = 2)
wire3d(neuron_mesh, col = "cyan", alpha = 0.2)</a></code></pre>
</div>
<div id="skeletor" class="section level3">
<h3 class="hasAnchor">
<a href="#skeletor" class="anchor"></a>Skeletor</h3>
<p>You may also want to install <a href="https://github.com/schlegelp/skeletor">skeletor</a>, an package from Philipp Schlegel that helps you thin and skeletonise meshes yourself. To install, do:</p>
<pre><code>$ source activate flywire_env
$ conda install nomkl
$ pip3 install git+git://github.com/schlegelp/skeletor@master
$ pip3 install fastremap
$ pip3 install ncollpyde</code></pre>
</div>
<div id="issues" class="section level3">
<h3 class="hasAnchor">
<a href="#issues" class="anchor"></a>Issues</h3>
<p>If you run into issues, you can try wiping and re-initiating your conda environment. You can try without igneous and PyChunkedGraph.</p>
<p>For example:</p>
<pre><code>$ conda remove -n flywire_env --all
$ conda create --name flywire_env python=3.7 conda=4.8.3
$ conda activate flywire_env
$ conda install nomkl
$ conda install -c conda-forge pykdtree
$ pip install cloud-volume meshparty</code></pre>
<p>If you are still encountering issues, just try using your base conda environment.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#background">Background</a></li>
      <li><a href="#install-conda">Install conda</a></li>
      <li><a href="#work-with-a-new-environment">Work with a new environment</a></li>
      <li><a href="#install-cloudvolume">Install cloudvolume</a></li>
      <li><a href="#install-meshparty">Install meshparty</a></li>
      <li><a href="#working-with-r-and-python">Working with R and python</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
