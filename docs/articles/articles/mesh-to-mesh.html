<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesh to mesh distances • fafbseg</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Mesh to mesh distances">
<meta property="og:description" content="fafbseg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">fafbseg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/FAFB-FlyWire.html">FAFB-FlyWire</a>
    </li>
    <li>
      <a href="../../articles/articles/accessing-graphene-server.html">Accessing the chunked graph server</a>
    </li>
    <li>
      <a href="../../articles/articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a>
    </li>
    <li>
      <a href="../../articles/articles/installing-cloudvolume-meshparty.html">Installing python modules: cloudvolume, meshparty and skeletor</a>
    </li>
    <li>
      <a href="../../articles/articles/mesh-to-mesh.html">Mesh to mesh distances</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
<li>
  <a href="../../SUPPORT.html">Help</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://natverse.github.io">natverse</a>
</li>
<li>
  <a href="https://github.com/natverse/fafbseg">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mesh-to-mesh_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Mesh to mesh distances</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/fafbseg/blob/master/vignettes/articles/mesh-to-mesh.Rmd"><code>vignettes/articles/mesh-to-mesh.Rmd</code></a></small>
      <div class="hidden name"><code>mesh-to-mesh.Rmd</code></div>

    </div>

    
    
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>This is an <a href="http://rmarkdown.rstudio.com">R Markdown</a> Notebook. When you execute code within the notebook, the results appear beneath the code.</p>
<p>Try executing this chunk by clicking the <em>Run</em> button within the chunk or by placing your cursor inside it and pressing <em>Cmd+Shift+Enter</em>.</p>
</div>
<div id="find-the-distance-between-meshes" class="section level2">
<h2 class="hasAnchor">
<a href="#find-the-distance-between-meshes" class="anchor"></a>Find the distance between meshes</h2>
<p>There are two ways that I can immediately think of addressing this</p>
<ol style="list-style-type: decimal">
<li>Find the distance of every vertex on mesh 1 to its nearest neighbour on mesh 2</li>
<li>Find the (signed) distance from every vertex of mesh 1 to the surface of mesh 2</li>
</ol>
<p>Obviously the ideal situation would be to find the mesh to mesh distances for the two objects (or even do a Euclidean distance transform on the voxel representation of the objects.) but neither of those are so accessible.</p>
<p>Option 1 is probably still a perfectly good option for most purposes since the meshes are quite densely sampled (i.e. the vertices are close together).</p>
</div>
<div id="setup-and-mesh-volume" class="section level2">
<h2 class="hasAnchor">
<a href="#setup-and-mesh-volume" class="anchor"></a>Setup and Mesh volume</h2>
<p>Let’s use the same example that I mentioned on FlyWire slack.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/fafbseg">fafbseg</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: nat</code></pre>
<pre><code>## Loading required package: rgl</code></pre>
<pre><code>## Registered S3 method overwritten by 'nat':
##   method             from
##   as.mesh3d.ashape3d rgl</code></pre>
<pre><code>## 
## Attaching package: 'nat'</code></pre>
<pre><code>## The following object is masked from 'package:rgl':
## 
##     wire3d</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, union</code></pre>
<pre><code>## Run dr_fafbseg() for a status report on your installation</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../../reference/choose_segmentation.html">choose_segmentation</a></span><span class="op">(</span><span class="st">"flywire31"</span><span class="op">)</span>
<span class="va">va6pn</span><span class="op">=</span><span class="fu"><a href="../../reference/read_cloudvolume_meshes.html">read_cloudvolume_meshes</a></span><span class="op">(</span><span class="st">"720575940633169983"</span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required namespace: readobj</code></pre>
<pre><code>##   downloading meshes</code></pre>
<pre><code>## Loading required namespace: reticulate</code></pre>
<pre><code>##   parsing downloaded meshes</code></pre>
<p>There we were asked to find the volume of a mesh. The first attempt fails</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgVolume.html">vcgVolume</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>So we need to clean up the mesh:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">va6pn.clean</span><span class="op">=</span><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgClean.html">vcgClean</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, sel<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, iterate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<pre><code>## removed 68 duplicate faces and 0 duplicate vertices
## removed 0 unreferenced vertices
## removed 33 Non-manifold faces
## removed 0 degenerate faces
## removed 17 Non-manifold vertices
## split 2 non-manifold vertices
## merged 0 close vertices
## removed 0 duplicate faces and 0 duplicate vertices
## removed 11 unreferenced vertices
## removed 0 Non-manifold faces
## removed 0 degenerate faces
## removed 2 Non-manifold vertices
## split 0 non-manifold vertices
## merged 0 close vertices</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vol</span><span class="op">=</span><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgVolume.html">vcgVolume</a></span><span class="op">(</span><span class="va">va6pn.clean</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in Rvcg::vcgVolume(va6pn.clean): Mesh is not watertight! USE RESULT WITH
## CARE!</code></pre>
<pre><code>## Warning in Rvcg::vcgVolume(va6pn.clean): Mesh is not coherently oriented! USE
## RESULT WITH CARE!</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vol</span></code></pre></div>
<pre><code>## [1] 2.51251e+12</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># cubic microns </span>
<span class="va">vol</span><span class="op">/</span><span class="fl">1e9</span> </code></pre></div>
<pre><code>## [1] 2512.51</code></pre>
<div id="compare-with-neurons-skeleton-available-from-vfb-catmaid" class="section level3">
<h3 class="hasAnchor">
<a href="#compare-with-neurons-skeleton-available-from-vfb-catmaid" class="anchor"></a>Compare with neuron’s skeleton available from VFB catmaid</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/elmr">elmr</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: catmaid</code></pre>
<pre><code>## Loading required package: httr</code></pre>
<pre><code>## Loading required package: nat.flybrains</code></pre>
<pre><code>## Loading required package: nat.templatebrains</code></pre>
<pre><code>## Loading required package: nat.nblast</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">va6pn.skel</span><span class="op">=</span><span class="fu">read.neurons.catmaid</span><span class="op">(</span><span class="st">"name:VA6.*PN"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">va6pn.skel</span><span class="op">)</span></code></pre></div>
<pre><code>##       root nodes segments branchpoints endpoints cable.length connectors nsoma
## 16   11222 16840     2402         1172      1231      4003103       2158     1
## 3133  5762 19832     2974         1461      1514      4800869       1026     1</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cable.length</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">va6pn.skel</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"cable.length"</span><span class="op">]</span>
<span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span> <span class="co"># in nm</span></code></pre></div>
<pre><code>## [1] 627640.6</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span><span class="op">/</span><span class="fl">1e6</span> <span class="co"># in µm</span></code></pre></div>
<pre><code>## [1] 0.6276406</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">A</span><span class="op">=</span><span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span><span class="op">/</span><span class="fl">1e6</span> <span class="co"># mean area µm2</span>
<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">A</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span> <span class="co"># implied radius µm, seems reasonable</span></code></pre></div>
<pre><code>## [1] 0.3160571</code></pre>
</div>
</div>
<div id="option-1-vertex-to-vertex-distance" class="section level2">
<h2 class="hasAnchor">
<a href="#option-1-vertex-to-vertex-distance" class="anchor"></a>Option 1: Vertex to vertex distance</h2>
<p>So let’s try and find the vertex to vertex distance for a pair of neurons. We happen to know that this lateral horn local interneuron is a target of the VA6 PN.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pv4b4</span><span class="op">=</span><span class="fu"><a href="../../reference/read_cloudvolume_meshes.html">read_cloudvolume_meshes</a></span><span class="op">(</span><span class="st">'720575940619630430'</span><span class="op">)</span></code></pre></div>
<pre><code>##   downloading meshes</code></pre>
<pre><code>##   parsing downloaded meshes</code></pre>
<p>Now we can use a <a href="https://en.wikipedia.org/wiki/K-d_tree">k-d tree</a> to find the nearest neighbour distances very efficiently. Note also the use of the <a href="http://natverse.org/nat/reference/xyzmatrix.html"><code>xyzmatrix</code></a> function to extract vertex locations - this works for all objects that the natverse knows about.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># better to make the tree from the larger object </span>
<span class="co"># and query using points from the smaller object</span>
<span class="fu">nvertices</span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span></code></pre></div>
<pre><code>## 720575940619630430 
##             101419</code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">nvertices</span><span class="op">(</span><span class="va">va6pn</span><span class="op">)</span></code></pre></div>
<pre><code>## 720575940633169983 
##             877023</code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kd</span><span class="op">=</span><span class="fu">nabor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nabor/man/knn.html">knn</a></span><span class="op">(</span>query <span class="op">=</span> <span class="fu"><a href="../../reference/xyzmatrix.ng_raw.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span>, data<span class="op">=</span><span class="fu"><a href="../../reference/xyzmatrix.ng_raw.html">xyzmatrix</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">kd</span><span class="op">)</span></code></pre></div>
<pre><code>## List of 2
##  $ nn.idx  : int [1:101419, 1] 4099 4099 4099 4099 4099 4099 4099 4099 4099 4099 ...
##  $ nn.dists: num [1:101419, 1] 30734 30587 30712 30724 30613 ...</code></pre>
<p>This gives us:</p>
<ol style="list-style-type: decimal">
<li>a set of vertex indices for the closest match on the VA6 PN for every vertex on the LHLN</li>
<li>the distances to those matching vertices</li>
</ol>
<p>We can take a look at the distribution of the distances like so:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span>, br<span class="op">=</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>You can see that there are actually quite a lot of close distances.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span>, br<span class="op">=</span><span class="fl">500</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2000</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>and I assume that the excess of distances &lt;1000 nm where there is a little dip in the distribution is related to this being a pair of neurons that are actually synaptically connected.</p>
<div id="locations-of-closest-approach" class="section level3">
<h3 class="hasAnchor">
<a href="#locations-of-closest-approach" class="anchor"></a>Locations of closest approach</h3>
<p>OK. So where do those meshes actually approach each other. Well we could look at the locations of the very closest distances &lt;100 nm. How many are there?</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1508</code></pre>
<p>Still a lot! This is because at a location of close approach between the neurons, there will be multiple vertices that are very close together. Separating out these distinct contact locations is a more complex problem than simply calculating all of these vertex distances. The first thing we could do is throw out cases where the same vertex on the target neuron is a match.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.idx</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1021</code></pre>
<p>Looks like that would reduce by a third.</p>
</div>
<div id="visualising-contacts" class="section level3">
<h3 class="hasAnchor">
<a href="#visualising-contacts" class="anchor"></a>Visualising contacts</h3>
<p>Let’s just take a quick detour and see what the close approaches look like:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/setupKnitr.html">setupKnitr</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">nopen3d</span><span class="op">(</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">pv4b4</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">va6pn</span>, col<span class="op">=</span><span class="st">'red'</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span>
<span class="fu">spheres3d</span><span class="op">(</span><span class="fu"><a href="../../reference/xyzmatrix.ng_raw.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>,<span class="op">]</span>, col<span class="op">=</span><span class="st">'green'</span>, r<span class="op">=</span><span class="fl">500</span><span class="op">)</span></code></pre></div>
<p>Show close nodes on the query mesh</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">nclear3d</span><span class="op">(</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">pv4b4</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">va6pn</span>, col<span class="op">=</span><span class="st">'grey'</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="mesh-to-mesh_insertimage_3.png" alt=""><p class="caption">LHLN + PN</p>
</div>
<p>Just the query mesh</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">nclear3d</span><span class="op">(</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">pv4b4</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="mesh-to-mesh_insertimage_1.png" alt=""><p class="caption">LHLN with close contact areas in red</p>
</div>
</div>
<div id="identifying-discrete-contact-zones" class="section level3">
<h3 class="hasAnchor">
<a href="#identifying-discrete-contact-zones" class="anchor"></a>Identifying discrete contact zones</h3>
<p>There are a range of ways this could be done, essentially what we have is a number of local minima in the distance field to find. It might also be the case that one “patch” on one neuron actually matches several patches on the other neuron. However we’ll just try to pick a simpler approach as an example.</p>
<p>Let’s take the points below threshold distance on the query neuron and find the geodesic distance (i.e. the distance along the mesh surface) between them.</p>
<p>We need to do a bit of prep work for this, to make a graph representation of the mesh.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Make an igraph representation of the edge network of a mesh object</span>
<span class="co">#'</span>
<span class="co">#' @param x A \code{mesh3d} object or an object for which an \code{as.mesh3d}</span>
<span class="co">#'   method is defined. As a convenience the first mesh object is extracted when</span>
<span class="co">#'   \code{x} is a \code{shapelist3d} object.</span>
<span class="co">#' @param ... additional arguments passed to \code{as.mesh3d}</span>
<span class="co">#'</span>
<span class="co">#' @return a \code{igraph} object whose vertices correspond to the vertices of the</span>
<span class="co">#'   original mesh object and whose edges have weights matching the edge lengths</span>
<span class="co">#'   in the mesh.</span>
<span class="co">#' @export</span>
<span class="va">mesh2graph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'shapelist3d'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'neuronlist'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'mesh3d'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="fu">as.mesh3d</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">)</span><span class="op">!=</span><span class="fl">3</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"I only work for triangulat meshes right now"</span><span class="op">)</span>
  
  <span class="co"># make the edge list</span>
  <span class="va">v1</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
  <span class="va">v2</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>
  <span class="va">v3</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span>
  <span class="va">el</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">v1</span>,<span class="va">v2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">v1</span>,<span class="va">v3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">v2</span>,<span class="va">v3</span><span class="op">)</span><span class="op">)</span>
  <span class="va">g</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_edgelist.html">graph_from_edgelist</a></span><span class="op">(</span><span class="va">el</span>, directed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  
  <span class="co"># calculate lengths of each edge</span>
  <span class="va">xyz</span><span class="op">=</span><span class="fu"><a href="../../reference/xyzmatrix.ng_raw.html">xyzmatrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">edgelengths</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v1</span>, <span class="va">v2</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">deltas</span><span class="op">=</span><span class="va">xyz</span><span class="op">[</span><span class="va">v1</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span><span class="op">-</span><span class="va">xyz</span><span class="op">[</span><span class="va">v2</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">deltas</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">weights</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">edgelengths</span><span class="op">(</span><span class="va">v1</span>,<span class="va">v2</span><span class="op">)</span>, <span class="fu">edgelengths</span><span class="op">(</span><span class="va">v1</span>,<span class="va">v3</span><span class="op">)</span>, <span class="fu">edgelengths</span><span class="op">(</span><span class="va">v2</span>,<span class="va">v3</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/E.html">E</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">weight</span><span class="op">=</span><span class="va">weights</span>
  <span class="va">g</span>
<span class="op">}</span></code></pre></div>
<p>Convert the LHLN to this mesh representation</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">g</span><span class="op">=</span><span class="fu">mesh2graph</span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span></code></pre></div>
<p>Now we can find the geodesic distance between all selected nodes.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dmat</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/distances.html">distances</a></span><span class="op">(</span><span class="va">g</span>, v<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s try clustering that distance matrix</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="va">dmat</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dd</span>, labels <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># cut using a height relating to a separation of 3000nm</span>
<span class="va">groups</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">dd</span>, h<span class="op">=</span><span class="fl">3000</span><span class="op">)</span>
<span class="co"># sample randomises colours so that neighbouring clusters have different colours</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">groupcols</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">groups</span><span class="op">]</span>

<span class="fu">nclear3d</span><span class="op">(</span><span class="op">)</span>
<span class="fu">spheres3d</span><span class="op">(</span><span class="fu"><a href="../../reference/xyzmatrix.ng_raw.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>,<span class="op">]</span>, col<span class="op">=</span><span class="va">groupcols</span>, rad<span class="op">=</span><span class="fl">200</span><span class="op">)</span>
<span class="fu">wire3d</span><span class="op">(</span><span class="va">pv4b4</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="figure">
<img src="mesh-to-mesh_insertimage_2.png" alt=""><p class="caption">Close contacts in different colours</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
