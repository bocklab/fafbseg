context("test-ids")

test_that("simple ids", {
  # temporarily use test zip folder
  op <- options(fafbseg.skelziproot = 'testdata/skeletonzip/')
  on.exit(options(op))

  expect_equal(segmentid2zip(10001654273), "10001.zip")

  baseline = structure(
    c(10001654273, 10001654273, 10001654273, 0, 1, 2),
    .Dim = 3:2,
    .Dimnames = list(NULL, c("segment", "fragment"))
  )
  expect_equal(swc2segmentid(sprintf("10001654273.%d.swc", 0:2), include.fragment=TRUE),
               baseline)

  expect_equal(segmentid2zip(swc2segmentid("10001654273.1.swc")), "10001.zip")

  # check for error when we specify a non-existent folder
  options(fafbseg.skelziproot = tempfile())
  expect_error(segmentid2zip(10001654273))
})

test_that('ngl_segments', {
  baseline=as.character(c(10950626347, 10952282491, 13307888342))
  # json file
  expect_equal(ngl_segments("testdata/testscene.json"), baseline)
  # json text
  expect_equal(ngl_segments(readLines("testdata/testscene.json")), baseline)
  # R list
  scene=jsonlite::fromJSON("testdata/testscene.json")
  expect_equal(ngl_segments(scene), baseline)
  expect_equal(ngl_segments(ngl_encode_url(body = scene)), baseline)

  # list with two sets of segments
  expect_warning(ngl_segments("testdata/testscene-double.json"))
})


test_that('flywire segments', {
  fcurl="https://neuromancer-seung-import.appspot.com/#!%7B%22layers%22:%5B%7B%22source%22:%22precomputed://gs://microns-seunglab/drosophila_v0/alignment/vector_fixer30_faster_v01/v4/image_stitch_v02%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Image%22%7D%2C%7B%22source%22:%22graphene://https://fafbv2.dynamicannotationframework.com/segmentation/1.0/fly_v26%22%2C%22type%22:%22segmentation_with_graph%22%2C%22selectedAlpha%22:0.1%2C%22segmentColors%22:%7B%22720575940615118379%22:%22#f8ff79%22%2C%22720575940639495437%22:%22#97ff32%22%7D%2C%22segments%22:%5B%22720575940609057772%22%2C%22720575940628716862%22%2C%22720575940631951940%22%5D%2C%22hiddenSegments%22:%5B%22720575940415076500%22%2C%22720575940597502225%22%2C%22720575940597504529%22%2C%22720575940607945290%22%2C%22720575940607945546%22%2C%22720575940609059820%22%2C%22720575940609464529%22%2C%22720575940610191025%22%2C%22720575940611936689%22%2C%22720575940611938993%22%2C%22720575940611957425%22%2C%22720575940612060849%22%2C%22720575940612306609%22%2C%22720575940612630330%22%2C%22720575940612632122%22%2C%22720575940612639290%22%2C%22720575940612639802%22%2C%22720575940612923706%22%2C%22720575940612924218%22%2C%22720575940612924474%22%2C%22720575940612926266%22%2C%22720575940612926522%22%2C%22720575940612928570%22%2C%22720575940612932666%22%2C%22720575940612932922%22%2C%22720575940612943674%22%2C%22720575940612945722%22%2C%22720575940612945978%22%2C%22720575940612946234%22%2C%22720575940612947514%22%2C%22720575940612947770%22%2C%22720575940612948794%22%2C%22720575940612949050%22%2C%22720575940612949562%22%2C%22720575940612949818%22%2C%22720575940612950586%22%2C%22720575940612965434%22%2C%22720575940612968762%22%2C%22720575940612969786%22%2C%22720575940612975418%22%2C%22720575940613419697%22%2C%22720575940614447674%22%2C%22720575940614476090%22%2C%22720575940615935802%22%2C%22720575940616167979%22%2C%22720575940616245547%22%2C%22720575940616339066%22%2C%22720575940616858426%22%2C%22720575940616877370%22%2C%22720575940616974906%22%2C%22720575940622666491%22%2C%22720575940623916973%22%2C%22720575940623917997%22%2C%22720575940623988909%22%2C%22720575940623990445%22%2C%22720575940624091309%22%2C%22720575940624091821%22%2C%22720575940624092077%22%2C%22720575940624755262%22%2C%22720575940625276333%22%2C%22720575940625278893%22%2C%22720575940625279149%22%2C%22720575940628256941%22%2C%22720575940628257965%22%2C%22720575940628258221%22%2C%22720575940628258733%22%2C%22720575940628259245%22%2C%22720575940628260013%22%2C%22720575940628260269%22%2C%22720575940628388525%22%2C%22720575940629887774%22%2C%22720575940630320958%22%2C%22720575940631495069%22%2C%22720575940631627421%22%2C%22720575940631629213%22%2C%22720575940631634589%22%2C%22720575940631636381%22%2C%22720575940631642525%22%2C%22720575940631642781%22%2C%22720575940631643805%22%2C%22720575940631644317%22%2C%22720575940631646365%22%2C%22720575940631654045%22%2C%22720575940632422317%22%2C%22720575940632474541%22%2C%22720575940633147166%22%2C%22720575940639460877%22%2C%22720575940639491341%22%2C%22720575940639495693%22%2C%22720575940639496461%22%2C%22720575940639496717%22%2C%22720575940639498253%22%2C%22720575940639520525%22%2C%22720575940639522317%22%2C%22720575940643008070%22%2C%22720575940643008326%22%2C%22720575940644836166%22%2C%22720575940644949830%22%2C%22720575940648192838%22%2C%22720575940651478036%22%2C%22720575940651644436%22%5D%2C%22skeletonRendering%22:%7B%22mode2d%22:%22lines_and_points%22%2C%22mode3d%22:%22lines%22%7D%2C%22graphOperationMarker%22:%5B%7B%22annotations%22:%5B%5D%2C%22tags%22:%5B%5D%7D%2C%7B%22annotations%22:%5B%5D%2C%22tags%22:%5B%5D%7D%5D%2C%22name%22:%22SANDBOX_CHANGES%20NOT%20SAVED%20TO%20REAL%20DATASET%22%7D%5D%2C%22navigation%22:%7B%22pose%22:%7B%22position%22:%7B%22voxelSize%22:%5B4%2C4%2C40%5D%2C%22voxelCoordinates%22:%5B116967.84375%2C36816.7734375%2C2359.56982421875%5D%7D%7D%2C%22zoomFactor%22:3.7444200637176586%7D%2C%22perspectiveOrientation%22:%5B0.08711250126361847%2C0.1580400913953781%2C0.2011885792016983%2C0.9627865552902222%5D%2C%22perspectiveZoom%22:2611.3356233893137%2C%22showSlices%22:false%2C%22gpuMemoryLimit%22:2000000000%2C%22jsonStateServer%22:%22https://fafbv2.dynamicannotationframework.com/nglstate/post%22%2C%22selectedLayer%22:%7B%22layer%22:%22SANDBOX_CHANGES%20NOT%20SAVED%20TO%20REAL%20DATASET%22%2C%22visible%22:true%7D%2C%22layout%22:%22xy-3d%22%7D"
  sc=ngl_decode_scene(fcurl)
  expect_equal(
    ngl_segments(sc, as_character = T, include_hidden = F),
    c(
      "720575940609057772",
      "720575940628716862",
      "720575940631951940"
    )
  )

  expect_equal(
    ngl_segments(sc, as_character = T, include_hidden = TRUE),
    c(sc$layers[[2]]$segments, sc$layers[[2]]$hiddenSegments)
  )
})


test_that('neuroglancer segmentation for all built-in urls',  {
  releases=eval(formals(choose_segmentation)[['release']])
  for(r in releases) {
    with_segmentation(r,
      expect_is(ngl_segmentation(rval='url'), 'character'))
    }
})
